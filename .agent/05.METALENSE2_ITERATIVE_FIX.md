# METALENSE2 Critical Performance Fix - Iterative Debug Cycle

## Context

The app is running at **0.5 FPS** (2 seconds per frame!) on METALENSE2. This is causing all other issues including slow hand tracking. The root cause must be found and fixed.

**Continue working autonomously until I explicitly tell you to stop.**

---

## Current Performance Data

```
FPS: 0.5 (frame delta: 2019 ms)
Hand tracking calls/sec: 1 (interval: 2010 ms)
```

**Critical Issue**: The main render loop is taking ~2000ms per frame, which is ~100x slower than expected (should be ~16ms for 60 FPS).

---

## Your Task: Iterative Fix Cycle

You must follow this cycle until the performance is acceptable:

```
┌─────────────────────────────────────────────────────────────────┐
│  1. ANALYZE → 2. MODIFY → 3. BUILD → 4. INSTALL → 5. TEST      │
│       ↑                                              │          │
│       └──────────── IF NOT FIXED ←───────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### Step 1: ANALYZE
- Review logs and code to identify the bottleneck
- Look for blocking operations

### Step 2: MODIFY
- Make targeted code changes to fix the identified issue
- Add debug logging if needed

### Step 3: BUILD
```bash
cd d:/workspace/___2025___PNCSolution/__2026__Luancher_Apps/wolvic
./gradlew assembleSpacesArm64GeckoGenericDebug
```

### Step 4: INSTALL
```bash
adb install -r app/build/outputs/apk/spacesArm64GeckoGeneric/debug/Wolvic-spacesArm64GeckoGeneric-debug.apk
```

### Step 5: TEST
```bash
# Clear logs and start fresh
adb logcat -c

# Launch the app
adb shell am start -n com.igalia.wolvic.metalense/.VRBrowserActivity

# Wait 10 seconds for app to stabilize
sleep 10

# Check performance logs
adb logcat -d -s VRB:* | grep -E "FPS|frame|Hand tracking"
```

### Evaluate Results
**Success criteria:**
- FPS > 30 (frame delta < 33ms)
- Hand tracking calls > 30 per second

**If not met:** Return to Step 1 and try a different fix.

---

## Primary Suspects

### 1. xrWaitFrame Blocking (HIGHEST PRIORITY)

**File**: `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp`

The `xrWaitFrame` call may be blocking for too long. Check:
- Is it waiting for vsync incorrectly?
- Is there a timing issue with the OpenXR session?

**Search for:**
```cpp
xrWaitFrame
xrBeginFrame
xrEndFrame
```

**Possible fix**: Check if METALENSE2 requires different frame timing configuration.

### 2. Session State Issues

**File**: `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp`

Check session state handling:
```cpp
XR_SESSION_STATE_READY
XR_SESSION_STATE_SYNCHRONIZED  
XR_SESSION_STATE_VISIBLE
XR_SESSION_STATE_FOCUSED
```

The session may be stuck in a non-rendering state.

### 3. Passthrough Overhead

Check if passthrough is enabled and consuming resources:
- File: `app/src/openxr/cpp/OpenXRPassthroughStrategy.cpp`
- Try disabling passthrough completely for testing

### 4. Blend Mode Configuration

Check blend mode settings:
```cpp
XR_ENVIRONMENT_BLEND_MODE_OPAQUE      // Fastest
XR_ENVIRONMENT_BLEND_MODE_ALPHA_BLEND // Slower
XR_ENVIRONMENT_BLEND_MODE_ADDITIVE    // Slowest
```

### 5. Thread/Sync Issues

Check for:
- Mutex locks that might be blocking
- Thread synchronization issues
- JNI calls that might block

---

## Debugging Commands

### Add Frame Timing Logs

In DeviceDelegateOpenXR.cpp, around the render loop:

```cpp
auto frameStart = std::chrono::high_resolution_clock::now();

// Before xrWaitFrame
auto waitStart = std::chrono::high_resolution_clock::now();
CHECK_XRCMD(xrWaitFrame(session, &frameWaitInfo, &frameState));
auto waitEnd = std::chrono::high_resolution_clock::now();
auto waitTime = std::chrono::duration_cast<std::chrono::milliseconds>(waitEnd - waitStart);
VRB_LOG("xrWaitFrame took: %lld ms", waitTime.count());

// Before xrBeginFrame
auto beginStart = std::chrono::high_resolution_clock::now();
CHECK_XRCMD(xrBeginFrame(session, nullptr));
auto beginEnd = std::chrono::high_resolution_clock::now();
auto beginTime = std::chrono::duration_cast<std::chrono::milliseconds>(beginEnd - beginStart);
VRB_LOG("xrBeginFrame took: %lld ms", beginTime.count());

// ... rendering ...

// Before xrEndFrame  
auto endStart = std::chrono::high_resolution_clock::now();
CHECK_XRCMD(xrEndFrame(session, &frameEndInfo));
auto endEnd = std::chrono::high_resolution_clock::now();
auto endTime = std::chrono::duration_cast<std::chrono::milliseconds>(endEnd - endStart);
VRB_LOG("xrEndFrame took: %lld ms", endTime.count());
```

### Find Blocking Code

```bash
# Search for potential blocking operations
grep -rn "sleep\|Sleep\|wait\|Wait\|mutex\|lock\|synchronized" --include="*.cpp" --include="*.java" app/src/openxr/ app/src/main/cpp/
```

---

## Quick Fixes to Try

### Fix 1: Check for METALENSE2-specific timing

Look for device-specific code that might affect timing:
```bash
grep -rn "Metalense\|METALENSE\|LenovoA3" --include="*.cpp" app/src/
```

### Fix 2: Disable vsync or frame pacing

Look for vsync or frame pacing settings that might cause delays.

### Fix 3: Skip frame waiting for testing

Temporarily bypass xrWaitFrame to test:
```cpp
// If xrWaitFrame is blocking, try skipping under certain conditions
#if defined(SPACES)
    if (DeviceUtils::GetDeviceTypeFromSystem() == device::Metalense2) {
        // Use different timing approach
    }
#endif
```

### Fix 4: Check OpenXR session creation

Verify session is created with correct parameters for METALENSE2.

---

## Log Analysis Guide

When you see logs, look for:

| Log Pattern | Meaning | Action |
|------------|---------|--------|
| `xrWaitFrame took: 2000+ ms` | WaitFrame is blocking | Check frame timing/vsync |
| `xrBeginFrame took: 2000+ ms` | BeginFrame is blocking | Check session state |
| `xrEndFrame took: 2000+ ms` | EndFrame is blocking | Check layer submission |
| `Session state: SYNCHRONIZED` | Not fully running | Wait for FOCUSED state |
| `XR_ERROR_*` | OpenXR error | Fix the specific error |

---

## Important Files

| File | Purpose |
|------|---------|
| `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp` | Main OpenXR render loop |
| `app/src/openxr/cpp/OpenXRInputSource.cpp` | Hand tracking |
| `app/src/openxr/cpp/OpenXRExtensions.cpp` | Extension handling |
| `app/src/main/cpp/BrowserWorld.cpp` | Main update loop |
| `app/src/main/cpp/DeviceUtils.cpp` | Device detection |

---

## Iteration Log Template

For each iteration, document:

```
### Iteration N
**Hypothesis**: [What you think is causing the issue]
**Change Made**: [What you changed]
**File(s) Modified**: [Which files]
**Result**: [FPS after change]
**Next Step**: [What to try next if not fixed]
```

---

## Success Criteria

The fix is successful when:

- [ ] FPS > 30 (ideally 60+)
- [ ] Frame delta < 33ms
- [ ] Hand tracking > 30 calls/sec
- [ ] App feels responsive
- [ ] No regression on Lenovo A3

---

## DO NOT STOP UNTIL

1. The performance is acceptable (FPS > 30), OR
2. You have exhausted all options and documented what you tried, OR
3. I explicitly tell you to stop

**Keep iterating through the ANALYZE → MODIFY → BUILD → INSTALL → TEST cycle!**
