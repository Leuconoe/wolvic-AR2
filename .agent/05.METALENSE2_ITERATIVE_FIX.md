# METALENSE2 Critical Performance Fix - Iterative Debug Cycle

## Context

The app is running at **0.5 FPS** (2 seconds per frame!) on METALENSE2. This is causing all other issues including slow hand tracking. The root cause must be found and fixed.

**Continue working autonomously until I explicitly tell you to stop.**

---

## Current Performance Data

```
FPS: 0.5 (frame delta: 2019 ms)
Hand tracking calls/sec: 1 (interval: 2010 ms)
```

**Critical Issue**: The main render loop is taking ~2000ms per frame, which is ~100x slower than expected (should be ~16ms for 60 FPS).

---

## Your Task: Iterative Fix Cycle

You must follow this cycle until the performance is acceptable:

```
┌──────────────────────────────────────────────────────────────────────────┐
│  1. ANALYZE → 2. MODIFY → 3. BUILD → 4. INSTALL → 5. TEST → 6. DOCUMENT │
│       ↑                                                      │           │
│       └────────────────── IF NOT FIXED ←─────────────────────┘           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Step 1: ANALYZE
- Review logs and code to identify the bottleneck
- Look for blocking operations

### Step 2: MODIFY
- Make targeted code changes to fix the identified issue
- Add debug logging if needed

### Step 3: BUILD
```bash
cd d:/workspace/___2025___PNCSolution/__2026__Luancher_Apps/wolvic
./gradlew assembleSpacesArm64GeckoGenericDebug
```

### Step 4: INSTALL
```bash
adb install -r app/build/outputs/apk/spacesArm64GeckoGeneric/debug/Wolvic-spacesArm64GeckoGeneric-debug.apk
```

### Step 5: TEST
```bash
# Clear logs and start fresh
adb logcat -c

# Launch the app
adb shell am start -n com.igalia.wolvic.metalense/.VRBrowserActivity

# Wait 10 seconds for app to stabilize
sleep 10

# Check performance logs
adb logcat -d -s VRB:* | grep -E "FPS|frame|Hand tracking"
```

### Step 6: DOCUMENT (IMPORTANT!)
After EACH test iteration, you MUST create/update a walkthrough document:

**File**: `.agents/walkthrough_iteration_N.md` (where N is the iteration number)

**Template**:
```markdown
# Iteration N - [Date/Time]

## Hypothesis
What you believed was causing the issue.

## Changes Made
- File: `path/to/file.cpp`
- Description of changes

## Build Result
- Success / Failure
- Any build errors encountered

## Test Result
- FPS: X (frame delta: Y ms)
- Hand tracking calls/sec: Z

## Log Output
```
[Paste relevant log output here]
```

## Analysis
- Did the change improve performance?
- What did you learn?

## Next Steps
- What will you try next if not fixed?
```

### Evaluate Results
**Success criteria:**
- FPS > 30 (frame delta < 33ms)
- Hand tracking calls > 30 per second

**If not met:** Return to Step 1 and try a different fix.

---

## Primary Suspects

### 1. xrWaitFrame Blocking (HIGHEST PRIORITY)

**File**: `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp`

The `xrWaitFrame` call may be blocking for too long. Check:
- Is it waiting for vsync incorrectly?
- Is there a timing issue with the OpenXR session?

**Add timing measurement:**
```cpp
VRB_LOG("METALENSE2_DEBUG: Before xrWaitFrame");
auto waitStart = std::chrono::high_resolution_clock::now();
CHECK_XRCMD(xrWaitFrame(m.session, &frameWaitInfo, &frameState));
auto waitEnd = std::chrono::high_resolution_clock::now();
auto waitMs = std::chrono::duration_cast<std::chrono::milliseconds>(waitEnd - waitStart).count();
VRB_LOG("METALENSE2_DEBUG: xrWaitFrame took %lld ms", waitMs);
```

### 2. Session State Issues

Check session state handling:
```cpp
XR_SESSION_STATE_READY
XR_SESSION_STATE_SYNCHRONIZED  
XR_SESSION_STATE_VISIBLE
XR_SESSION_STATE_FOCUSED
```

The session may be stuck in a non-rendering state.

### 3. Passthrough Overhead

Check if passthrough is enabled and consuming resources.

### 4. Blend Mode Configuration

Check blend mode settings - OPAQUE is fastest.

---

## Walkthrough Naming Convention

Create walkthroughs in this order:
- `.agents/walkthrough_iteration_01.md`
- `.agents/walkthrough_iteration_02.md`
- `.agents/walkthrough_iteration_03.md`
- etc.

Each walkthrough should be a complete record of that iteration's attempt.

---

## Summary Walkthrough

After multiple iterations, create a summary:

**File**: `.agents/walkthrough_summary.md`

Include:
- Total iterations attempted
- What worked / what didn't work
- Final solution (if found)
- Remaining issues

---

## Build and Test Commands (Quick Reference)

```bash
# Full cycle
cd d:/workspace/___2025___PNCSolution/__2026__Luancher_Apps/wolvic
./gradlew assembleSpacesArm64GeckoGenericDebug
adb install -r app/build/outputs/apk/spacesArm64GeckoGeneric/debug/Wolvic-spacesArm64GeckoGeneric-debug.apk
adb logcat -c
adb shell am start -n com.igalia.wolvic.metalense/.VRBrowserActivity
sleep 10
adb logcat -d -s VRB:* | grep -E "FPS|frame|Hand tracking|xrWaitFrame|METALENSE2"
```

---

## Important Files

| File | Purpose |
|------|---------|
| `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp` | Main OpenXR render loop |
| `app/src/openxr/cpp/OpenXRInputSource.cpp` | Hand tracking |
| `app/src/openxr/cpp/OpenXRExtensions.cpp` | Extension handling |
| `app/src/main/cpp/BrowserWorld.cpp` | Main update loop |
| `app/src/main/cpp/DeviceUtils.cpp` | Device detection |

---

## Success Criteria

The fix is successful when:

- [ ] FPS > 30 (ideally 60+)
- [ ] Frame delta < 33ms
- [ ] Hand tracking > 30 calls/sec
- [ ] App feels responsive
- [ ] No regression on Lenovo A3

---

## DO NOT STOP UNTIL

1. The performance is acceptable (FPS > 30), OR
2. You have exhausted all options and documented what you tried, OR
3. I explicitly tell you to stop

**REMEMBER: Create a walkthrough document after EACH iteration!**

**Keep iterating through the ANALYZE → MODIFY → BUILD → INSTALL → TEST → DOCUMENT cycle!**
