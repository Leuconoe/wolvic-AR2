# METALENSE2 Porting Task for Wolvic XR Browser

## Project Overview

This project is an XR (Extended Reality) browser application called **Wolvic**, designed to run on VR/AR headsets. It is an open-source browser built on Mozilla's GeckoView engine with full WebXR support.

### Official Device Support
- The app officially supports **Lenovo A3** devices using the **Qualcomm Snapdragon Spaces SDK**
- The `spaces` build flavor is configured for Snapdragon Spaces-compatible devices

### Target Device
- **METALENSE2**: An AR device that also uses the Qualcomm Snapdragon Spaces SDK
- Despite using the same SDK as Lenovo A3, the app currently does not work on METALENSE2

---

## Your Objective

**Port this application to work on METALENSE2 devices.**

You must analyze the project, create a porting plan, implement necessary changes, build the app, test it, and fix any issues encountered. **Continue working autonomously until I explicitly tell you to stop.**

---

## Project Structure Analysis

### Build System
- **Build Tool**: Gradle with Android Studio
- **Build Configuration**: `app/build.gradle`
- **Native Build**: CMake (`app/CMakeLists.txt`)
- **Architecture**: arm64-v8a (primary)

### Key Directories

```
wolvic/
├── app/
│   ├── build.gradle          # Main build configuration with flavor definitions
│   ├── CMakeLists.txt        # Native C++ build configuration
│   └── src/
│       ├── main/             # Common source code
│       │   ├── cpp/          # Native C++ code
│       │   │   ├── Device.h          # Device type definitions
│       │   │   ├── DeviceUtils.cpp   # Device detection logic
│       │   │   └── ...
│       │   └── java/         # Java/Kotlin code
│       ├── spaces/           # Snapdragon Spaces specific code
│       │   ├── AndroidManifest.xml
│       │   ├── assets/
│       │   ├── java/
│       │   └── res/
│       ├── openxr/           # OpenXR implementation
│       │   └── cpp/
│       │       ├── DeviceDelegateOpenXR.cpp
│       │       ├── OpenXRExtensions.cpp
│       │       ├── OpenXRInputMappings.h
│       │       ├── OpenXRInputSource.cpp
│       │       └── ...
│       └── common/           # Shared code across platforms
│           └── shared/
│               └── com/igalia/wolvic/utils/
│                   └── DeviceType.java
├── third_party/
│   └── spaces/               # Snapdragon Spaces SDK (libopenxr_loader.aar)
└── README.md
```

---

## Critical Files to Examine

### 1. Device Detection (C++)
**File**: `app/src/main/cpp/DeviceUtils.cpp`
```cpp
device::DeviceType DeviceUtils::GetDeviceTypeFromSystem() {
    char model[128];
    int length = PopulateDeviceModelString(model);

    if (deviceNamesMap.empty()) {
        deviceNamesMap.emplace("Quest", device::OculusQuest);
        deviceNamesMap.emplace("motorola edge 30 pro", device::LenovoA3);
        deviceNamesMap.emplace("VRX", device::LenovoVRX);
        // ... other devices
    }

    auto device = deviceNamesMap.find(model);
    if (device == deviceNamesMap.end()) {
        VRB_WARN("Device %s is not supported", model);
        return device::UnknownType;
    }
    return device->second;
}
```
**Action Required**: Add METALENSE2 device model string mapping

### 2. Device Type Definitions (C++)
**File**: `app/src/main/cpp/Device.h`
```cpp
const DeviceType LenovoA3 = 15;
const DeviceType LenovoVRX = 16;
// Add new: const DeviceType Metalense2 = XX;
```
**Action Required**: Add new DeviceType constant for METALENSE2

### 3. Device Type Definitions (Java)
**File**: `app/src/common/shared/com/igalia/wolvic/utils/DeviceType.java`
```java
public static final int LenovoA3 = 15;
public static final int LenovoVRX = 16;
// Add new: public static final int Metalense2 = XX;
```
**Action Required**: Mirror the C++ DeviceType constant in Java

### 4. Build Configuration
**File**: `app/build.gradle`
- The `spaces` flavor is already configured for Snapdragon Spaces SDK
- May need to add METALENSE2-specific configurations

### 5. AndroidManifest.xml
**File**: `app/src/spaces/AndroidManifest.xml`
- Contains Snapdragon Spaces-specific permissions and queries
- May need METALENSE2-specific intent filters or meta-data

### 6. OpenXR Extensions
**File**: `app/src/openxr/cpp/OpenXRExtensions.cpp`
- Contains device-specific OpenXR extension handling
- Check for any Lenovo-specific extension requirements

### 7. Input Mappings
**File**: `app/src/openxr/cpp/OpenXRInputMappings.h`
- Contains controller input mappings for each device
- May need METALENSE2-specific input mapping

---

## Porting Approach

### Phase 1: Device Identification

1. **Determine METALENSE2 Device Model String**
   - This is the string returned by `android.os.Build.MODEL` or equivalent
   - You may need to research or test to find the exact string

2. **Add Device Registration**
   - Add to `DeviceUtils.cpp` deviceNamesMap
   - Add DeviceType constant to `Device.h`
   - Add DeviceType constant to `DeviceType.java`
   - Update `@IntDef` annotation in DeviceType.java

### Phase 2: Configuration Analysis

1. **Check if METALENSE2 can use existing LenovoA3 configuration**
   - If hardware and SDK are similar, minimal changes may suffice
   - May just need device model string mapping

2. **Or create dedicated METALENSE2 support**
   - New DeviceType constant
   - Device-specific input mappings if controller differs
   - Device-specific OpenXR extensions if required

### Phase 3: Build Configuration

1. **Use existing `spaces` flavor** if compatible
2. **Or create new `metalense2` flavor** if significant differences exist

### Phase 4: Build and Test

1. Build command:
   ```bash
   ./gradlew assembleSpacesArm64GeckoGenericDebug
   ```
   
2. Install on device:
   ```bash
   adb install -r app/build/outputs/apk/spacesArm64GeckoGeneric/debug/Wolvic-*-debug.apk
   ```

3. Test on METALENSE2 device
4. Check logcat for errors:
   ```bash
   adb logcat | grep -E "(VRB|OpenXR|wolvic)"
   ```

---

## Known Issues to Investigate

1. **Device Detection Failure**: The app may not recognize METALENSE2, defaulting to `UnknownType`

2. **OpenXR Runtime**: Ensure Snapdragon Spaces runtime is properly installed on METALENSE2

3. **Hand Tracking**: Previous conversation history suggests hand tracking may have issues on METALENSE2
   - Check `XR_EXT_hand_interaction` extension handling
   - File: `app/src/openxr/cpp/OpenXRInputSource.cpp` line 427

4. **Package Name Conflicts**: May need to use different package name for METALENSE2
   - Reference: Previous attempt used `com.igalia.wolvic.metalense`

---

## Resources

- **Snapdragon Spaces SDK Documentation**: https://spaces.qualcomm.com/
- **OpenXR Specification**: https://www.khronos.org/openxr/
- **Wolvic Wiki**: https://github.com/Igalia/wolvic/wiki

---

## Instructions for the AI Agent

1. **Start by researching** the METALENSE2 device model string if not known
2. **Analyze all device-specific code** to understand what changes are needed
3. **Make minimal changes first** - try mapping METALENSE2 to existing LenovoA3 type
4. **Build the project** and fix any compilation errors
5. **If you have access to a device**, test and debug runtime issues
6. **If no device access**, document what testing would be required
7. **Create detailed logs** of all changes made
8. **Continue working** until explicitly told to stop

### Build Commands Reference

```bash
# Clean build
./gradlew clean

# Build Spaces flavor (Debug)
./gradlew assembleSpacesArm64GeckoGenericDebug

# Build Spaces flavor (Release)
./gradlew assembleSpacesArm64GeckoGenericRelease

# List all build variants
./gradlew tasks --all | grep assemble

# Install APK
adb install -r <path-to-apk>

# View logs
adb logcat -s VRB:* wolvic:* OpenXR:*
```

---

## Success Criteria

The porting is successful when:
1. ✅ App compiles without errors for METALENSE2
2. ✅ App installs on METALENSE2 device
3. ✅ App launches and displays the browser UI
4. ✅ Controller/hand tracking works properly
5. ✅ WebXR content renders correctly
6. ✅ All major features function as on Lenovo A3
