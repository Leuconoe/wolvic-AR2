# METALENSE2 Post-Build Issues - Fix Required

## Context

The initial METALENSE2 porting build was **successful**, but several runtime issues have been identified that require fixing. This document describes the issues and provides guidance for investigation and resolution.

**Continue working autonomously until I explicitly tell you to stop.**

---

## Issue #1: Passthrough Mode Performance Impact

### Problem
Passthrough mode is enabled by default, causing performance degradation on METALENSE2.

### Required Fix
Set the default Passthrough value to `false` for METALENSE2 devices.

### Investigation Areas

1. **Settings Store**
   - File: `app/src/common/shared/com/igalia/wolvic/browser/SettingsStore.java`
   - Look for passthrough-related preferences

2. **OpenXR Passthrough Strategy**
   - File: `app/src/openxr/cpp/OpenXRPassthroughStrategy.cpp`
   - Check initialization and default values

3. **Device Delegate**
   - File: `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp`
   - Look for passthrough initialization logic
   - Check for device-specific passthrough handling

### Search Commands
```bash
# Find passthrough-related code
grep -r "passthrough" --include="*.cpp" --include="*.h" --include="*.java" app/src/
grep -r "Passthrough" --include="*.cpp" --include="*.h" --include="*.java" app/src/
grep -r "PASSTHROUGH" --include="*.cpp" --include="*.h" --include="*.java" app/src/
```

### Possible Solutions
1. Add device check for METALENSE2 in passthrough initialization
2. Create device-specific default preference value
3. Disable passthrough in OpenXR session creation for METALENSE2

---

## Issue #2: Hand Tracking Not Working

### Problem
Hand tracking works correctly on Lenovo A3 but does **not function** on METALENSE2, despite both using Snapdragon Spaces SDK.

### Background Information
From previous debugging sessions, there were known issues with:
- `XR_EXT_hand_interaction` extension handling
- Hand Tracking Layer initialization
- Package name conflicts affecting system-level configuration

### Investigation Areas

1. **OpenXR Hand Interaction Extension**
   - File: `app/src/openxr/cpp/OpenXRInputSource.cpp`
   - Line ~427: Check `XR_EXT_hand_interaction` handling
   - There may be device-specific conditions blocking hand tracking

2. **OpenXR Extensions**
   - File: `app/src/openxr/cpp/OpenXRExtensions.cpp`
   - Check which extensions are enabled/disabled for Spaces devices
   - Line ~63: Device-specific extension handling

3. **Hand Tracking Subsystem**
   - Search for hand tracking initialization code
   - Check if there are device-specific workarounds for Lenovo devices

4. **AndroidManifest Configuration**
   - File: `app/src/spaces/AndroidManifest.xml`
   - Check hand tracking meta-data: `<meta-data android:name="handtracking" android:value="1" />`

### Search Commands
```bash
# Find hand tracking related code
grep -r "hand" --include="*.cpp" --include="*.h" app/src/openxr/
grep -r "XR_EXT_hand" --include="*.cpp" --include="*.h" app/src/
grep -r "handtracking" --include="*.xml" app/src/
```

### Key Code to Examine

```cpp
// app/src/openxr/cpp/OpenXRInputSource.cpp line ~427
if (OpenXRExtensions::IsExtensionSupported(XR_EXT_HAND_INTERACTION_EXTENSION_NAME) 
    && (DeviceUtils::GetDeviceTypeFromSystem() != device::MagicLeap2)) {
    // Hand interaction code
}
```

**Question**: Is there a similar condition that excludes METALENSE2?

### Debugging Steps
1. Check logcat for hand tracking related errors:
   ```bash
   adb logcat | grep -i "hand"
   ```

2. Verify OpenXR extensions available on METALENSE2:
   ```bash
   adb logcat | grep -i "extension"
   ```

3. Compare runtime behavior between Lenovo A3 and METALENSE2

### Possible Solutions
1. Add METALENSE2 to the list of devices that support hand tracking
2. Ensure `XR_EXT_hand_interaction` is enabled for METALENSE2
3. Check if METALENSE2 requires different hand tracking extension (`XR_MSFT_hand_interaction` vs `XR_EXT_hand_interaction`)

---

## Issue #3: Extremely Slow scrcpy Response

### Problem
Screen mirroring via scrcpy has extremely slow response times, making the device nearly unusable for debugging/testing.

### Possible Causes

1. **Main Thread Blocking**
   - Heavy processing on the UI thread
   - Excessive logging or debug output

2. **Render Loop Issues**
   - Frame rate problems
   - Vsync or timing issues

3. **OpenXR Session Handling**
   - Session state management problems
   - Excessive waiting or blocking in the render loop

4. **Surface/Display Issues**
   - Conflicts between XR display and Android surface
   - Double composition overhead

### Investigation Areas

1. **Native Render Loop**
   - File: `app/src/main/cpp/BrowserWorld.cpp`
   - Check for blocking operations or excessive work per frame

2. **OpenXR Frame Timing**
   - File: `app/src/openxr/cpp/DeviceDelegateOpenXR.cpp`
   - Look for `xrWaitFrame`, `xrBeginFrame`, `xrEndFrame` calls
   - Check for timing issues or excessive waits

3. **Java/Native Bridge**
   - Check for excessive JNI calls per frame
   - Look for main thread blocking

4. **Logging**
   - Excessive logging can severely impact performance
   - Check for debug logging in hot paths

### Search Commands
```bash
# Find potential blocking operations
grep -r "WaitFrame\|BeginFrame\|EndFrame" --include="*.cpp" app/src/
grep -r "Thread.sleep\|wait\|synchronized" --include="*.java" app/src/

# Check for excessive logging
grep -r "VRB_LOG\|VRB_DEBUG\|Log.d\|Log.v" --include="*.cpp" --include="*.java" app/src/
```

### Debugging Steps

1. **Profile with systrace**:
   ```bash
   python systrace.py -o trace.html gfx view sched
   ```

2. **Check CPU usage**:
   ```bash
   adb shell top -m 10
   ```

3. **Monitor frame timing**:
   ```bash
   adb logcat | grep -i "frame\|fps\|timing"
   ```

4. **Compare with Lenovo A3 behavior**

### Possible Solutions

1. **Reduce logging in release builds**
2. **Optimize render loop for METALENSE2**
3. **Check for device-specific surface handling**
4. **Investigate if passthrough (Issue #1) contributes to the lag**
   - Fixing Issue #1 first may help with Issue #3

---

## Priority Order

1. **Fix Issue #1 (Passthrough)** first - may improve overall performance
2. **Fix Issue #3 (scrcpy lag)** - critical for debugging
3. **Fix Issue #2 (Hand Tracking)** - core functionality

---

## Testing After Fixes

### For Each Issue
1. Build the modified app
2. Install on METALENSE2
3. Verify the fix
4. Test for regressions

### Build Command
```bash
./gradlew assembleSpacesArm64GeckoGenericDebug
adb install -r app/build/outputs/apk/spacesArm64GeckoGeneric/debug/Wolvic-*-debug.apk
```

### Validation Checklist
- [ ] Passthrough is disabled by default on METALENSE2
- [ ] Hand tracking works (hands visible, gestures recognized)
- [ ] scrcpy responsiveness is acceptable
- [ ] No performance regression compared to before fixes
- [ ] Lenovo A3 functionality still works (no regression)

---

## Additional Logs to Collect

```bash
# Full logcat capture during testing
adb logcat -c && adb logcat > metalense2_debug.log

# Filter for relevant logs
adb logcat -s VRB:* OpenXR:* wolvic:* Unity:* Spaces:*
```

---

## Important Note

The fixes should be **device-specific** where possible. Use device type checks to ensure changes for METALENSE2 don't break existing Lenovo A3 functionality:

```cpp
// C++ example
if (DeviceUtils::GetDeviceTypeFromSystem() == device::Metalense2) {
    // METALENSE2-specific code
}
```

```java
// Java example
if (DeviceType.getType() == DeviceType.Metalense2) {
    // METALENSE2-specific code
}
```
