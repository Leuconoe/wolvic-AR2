# METALENSE2 성능 이슈 전체 보고서 (2026-02-09)

## 1. 목적

METALENSE2에서 Wolvic XR Browser의 극심한 저성능(0.5 FPS)을 원인 분석하고, 재현 가능한 해결책을 도출한다.

## 2. 환경 및 제약

- OS: Windows
- 기기: METALENSE2
- 런타임: Snapdragon Spaces (Monado 기반 OpenXR)
- 빌드: `spacesArm64GeckoGenericDebug`
- 패키지: `com.igalia.wolvic.metalense`
- 문제 기준: FPS > 30, 프레임 델타 < 33ms, 핸드 트래킹 호출 > 30회/초

## 3. 초기 증상

- 평균 FPS: 0.5Hz
- 프레임 델타: 2013~2019ms (약 2초)
- 렌더 스레드가 `unix_stream_read_generic`(Monado IPC) 또는 GPU 큐 대기 상태 반복
- GPU 주파수는 최소 305MHz에 고정

## 4. 원인 분석 과정 (요약)

### 4.1 Swapchain sampleCount 불일치

- OpenXR `XrSwapchainCreateInfo.sampleCount`가 런타임 권장 값(4x MSAA)였고,
  FBO는 MSAA가 꺼져 있어 mismatch 발생.
- 조치: SPACES에서 `sampleCount = 1`로 고정

### 4.2 GPU 주파수 고정 문제

- OpenXR perf hint(SUSTAINED_HIGH)가 실제 GPU 주파수 상승을 유발하지 않음
- sysfs로 강제 올리면 GPU 사용률이 급감했으나 실서비스 적용 불가

### 4.3 해상도 스케일 실험

- 50% 해상도: 90 FPS
- 55% 이상: 2~4 FPS 또는 0 FPS
- 21% 픽셀 증가가 200배 이상 성능 저하로 이어짐 -> 비선형 원인 의심

### 4.4 정밀 타이밍 계측으로 진짜 병목 확인

- `xrWaitFrame`, `xrBeginFrame`, `xrEndFrame` 모두 수 ms 수준
- 프레임 2초 지연은 **렌더링 단계에서 발생**
- `BrowserWorld::Draw()` 단계에서 **Left/Right 각각 1000ms** 대기 확인

### 4.5 병목 위치 확정

- `BindEye()` -> `OpenXRSwapChain::AcquireImage()` 내부
- `xrWaitSwapchainImage`가 `XR_INFINITE_DURATION`으로 블록됨
- 원인: **Spaces 컴포지터가 6개 레이어를 합성할 수 없어 swapchain 이미지 반환 지연**

## 5. 최종 해결책

### 5.1 핵심 수정

- SPACES 빌드에서 `layersEnabled = false`로 강제
- 결과적으로 **OpenXR 레이어 수 = 1 (projection layer만 제출)**
- UI는 projection layer에 텍스처로 렌더링됨

### 5.2 해상도

- `kMetalense2ResolutionScale = 1.0f` 유지
- 풀 해상도(약 2560x1440/eye)에서 90 FPS 달성

## 6. 성능 검증 결과

| 설정 | FPS | 프레임 델타 | 레이어 수 |
|------|-----|-------------|-----------|
| 기존 (6 레이어, 55% 이상) | 0~4 | 105~2019ms | 6 |
| 수정 후 (1 레이어, 100%) | 90 | 7~14ms | 1 |

## 7. 변경 사항 요약

- [app/src/openxr/cpp/DeviceDelegateOpenXR.cpp](app/src/openxr/cpp/DeviceDelegateOpenXR.cpp)
  - SPACES에서 `layersEnabled = false`
  - `kMetalense2ResolutionScale = 1.0f` 유지
  - 기존 성능 개선: `sampleCount=1`, `attributes.samples=0`, SUSTAINED_HIGH
- 디버그 계측 코드 전부 제거
  - [app/src/main/cpp/native-lib.cpp](app/src/main/cpp/native-lib.cpp)
  - [app/src/main/cpp/BrowserWorld.h](app/src/main/cpp/BrowserWorld.h)
  - [app/src/main/cpp/BrowserWorld.cpp](app/src/main/cpp/BrowserWorld.cpp)

## 8. 결론

성능 저하의 핵심 원인은 **Spaces 런타임의 레이어 합성 비용**이었다.
레이어를 단일 projection layer로 줄이자, 풀 해상도에서도 안정적으로 90 FPS를 달성했다.

## 9. 잔여 리스크 및 권고

- SPACES 전체 디바이스에 동일 적용됨. LenovoA3 등에서 UI 렌더링 품질 확인 필요.
- GPU 주파수 고정 문제는 런타임 이슈로 남음. 하지만 현재 해결책으로 실사용 성능에 영향 없음.
- 향후 레이어 기반 UI 필요 시, 레이어 수를 1~2로 제한하는 정책 필요.
